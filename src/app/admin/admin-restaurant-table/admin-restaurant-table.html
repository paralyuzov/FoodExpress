<div class="min-h-screen mx-auto font-pt-sans p-2">
  <div
    class="bg-neutral-800/50 backdrop-blur-sm rounded-2xl border border-neutral-600/50 shadow-xl shadow-black/30 overflow-hidden">
    <p-table #dt2 [value]="restaurants()" [loading]="loading()" dataKey="id" [paginator]="true" [rows]="10"
      [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} restaurants"
      [globalFilterFields]="['name', 'address', 'phone', 'email']" [tableStyle]="{ 'min-width': '100%' }"
      class="p-datatable-sm" [expandedRowKeys]="expandedRows" (onRowExpand)="onRowExpand($event)"
      (onRowCollapse)="onRowCollapse($event)">
      <ng-template #caption>
        <div
          class="flex items-center justify-between rounded-t-2xl p-6 bg-neutral-800/80 border-b border-neutral-600/50">
          <div class="flex items-center gap-3">
            <h3 class="text-lg font-semibold text-amber-300">
              <i class="pi pi-building mr-2"></i>
              Restaurant Management
            </h3>
            <span class="px-3 py-1 bg-neutral-700 text-neutral-300 rounded-full text-sm">
              {{ restaurants().length }} total
            </span>
          </div>

          <div class="flex items-center gap-4">
            <p-iconfield iconPosition="left" class="relative">
              <p-inputicon class="text-neutral-400">
                <i class="pi pi-search"></i>
              </p-inputicon>
              <input pInputText type="text" (input)="dt2.filterGlobal($any($event.target).value, 'contains')"
                placeholder="Search restaurants by name, address, or email..."
                class="w-80 bg-neutral-700/50 border-neutral-600 text-neutral-100 placeholder-neutral-400 rounded-xl px-4 py-3 pl-12 focus:ring-2 focus:ring-amber-400 focus:border-transparent transition-all duration-200" />
            </p-iconfield>

            <p-button (onClick)="showCreateRestaurantForm()" icon="pi pi-plus" label="Add Restaurant" severity="success"
              class="bg-amber-500 hover:bg-amber-600 border-0 text-slate-900 font-semibold rounded-xl transition-all duration-200" />
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem"
            class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!"></th>
          <th class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!">
            <i class="pi pi-building text-amber-300 mr-2"></i>Name
          </th>
          <th class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!">
            <i class="pi pi-user text-amber-300 mr-2"></i>Address
          </th>
          <th class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!">
            <i class="pi pi-map-marker text-amber-300 mr-2"></i>Phone
          </th>
          <th class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!">
            <i class="pi pi-building text-amber-300 mr-2"></i>Email
          </th>
          <th class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!">
            <i class="pi pi-check-circle text-amber-300 mr-2"></i>Status
          </th>
          <th class="text-neutral-300! font-semibold! p-4! text-left! border-b! border-neutral-600! bg-neutral-800!">
            <i class="pi pi-cog text-amber-300 mr-2"></i>Actions
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-restaurant let-expanded="expanded">
        <tr>
          <td class="p-4! bg-neutral-700/10!">
            <p-button type="button" pRipple [pRowToggler]="restaurant" [text]="true" severity="secondary"
              [rounded]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" class="w-8 h-8" />
          </td>
          <td class="p-4! bg-neutral-700/10!">
            <div class="space-y-1">
              <div class="font-mono text-amber-400 font-semibold text-sm">
                {{ restaurant.name }}
              </div>
            </div>
          </td>

          <td class="p-4! bg-neutral-700/10!">
            <div class="space-y-1">
              <div class="text-neutral-100 font-medium">
                {{ restaurant.address }}
              </div>
            </div>
          </td>

          <td class="p-4! bg-neutral-700/10!">
            <div class="space-y-1">
              <div class="text-neutral-100 text-sm">{{ restaurant.phone }}</div>
            </div>
          </td>

          <td class="p-4! bg-neutral-700/10!">
            <div class="space-y-1">
              <div class="text-neutral-100 font-medium">{{ restaurant.email }}</div>
            </div>
          </td>

          <td class="p-4! bg-neutral-700/10!">
            <p-tag [value]="restaurant.isActive ? 'Active' : 'Inactive'"
              [severity]="restaurant.isActive ? 'success' : 'danger'"
              class="px-3 py-1 rounded-full text-xs font-medium" />
          </td>
          <td class="p-4! bg-neutral-700/10!">
            <div class="flex items-center gap-2">
              <p-button (onClick)="showEditRestaurantForm(restaurant.id)" icon="pi pi-pencil" size="small"
                severity="info" pTooltip="Edit Restaurant" tooltipPosition="top" class="w-8 h-8 rounded-lg" />
              <p-button (onClick)="onDeleteRestaurant($event, restaurant.id)" icon="pi pi-trash" size="small"
                severity="danger" pTooltip="Delete Restaurant" tooltipPosition="top" class="w-8 h-8 rounded-lg" />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #expandedrow let-restaurant>
        <tr>
          <td colspan="7">
            <div class="p-6 bg-neutral-900/30 border-l-4 border-amber-400">
              <div class="mb-6 p-4 bg-neutral-800/40 rounded-lg border border-neutral-600/30">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-4">
                    @if (restaurant.imageUrl) {
                    <img [src]="restaurant.imageUrl" [alt]="restaurant.name"
                      class="w-16 h-16 rounded-lg object-cover border border-neutral-600" />
                    }
                    <div>
                      <h3 class="text-lg font-semibold text-amber-300">{{ restaurant.name }}</h3>
                      @if (restaurant.description) {
                      <p class="text-neutral-300 text-sm mt-1">{{ restaurant.description }}</p>
                      }
                      <div class="flex items-center gap-4 mt-2 text-xs text-neutral-400">
                        <span><i class="pi pi-map-marker mr-1"></i>{{ restaurant.address }}</span>
                        <span><i class="pi pi-phone mr-1"></i>{{ restaurant.phone }}</span>
                        @if (restaurant.email) {
                        <span><i class="pi pi-envelope mr-1"></i>{{ restaurant.email }}</span>
                        }
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-3">
                    @if (restaurant.avgRating > 0) {
                    <div class="text-center">
                      <div class="text-amber-400 font-semibold">{{ restaurant.avgRating }}/5</div>
                      <div class="text-xs text-neutral-400">Rating</div>
                    </div>
                    } @if (restaurant.ratings && restaurant.ratings.length > 0) {
                    <div class="text-center">
                      <div class="text-neutral-300 font-semibold">
                        {{ restaurant.ratings.length }}
                      </div>
                      <div class="text-xs text-neutral-400">Reviews</div>
                    </div>
                    }
                    <div class="text-center">
                      <div class="text-neutral-300 font-semibold">
                        {{ restaurant.menus?.length || 0 }}
                      </div>
                      <div class="text-xs text-neutral-400">Menus</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-amber-300">
                  <i class="pi pi-list mr-2"></i>
                  Menus & Dishes Management
                </h4>
                <p-button (onClick)="showCreateMenuForm(restaurant.id)" label="Add Menu" icon="pi pi-plus"
                  severity="success" size="small" />
              </div>

              @if (restaurant.menus && restaurant.menus.length > 0) {
              <div class="space-y-4">
                @for (menu of restaurant.menus; track menu.id) {
                <div class="bg-neutral-800/50 rounded-lg p-4 border border-neutral-600/30">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <h5 class="font-semibold text-neutral-100">
                        <i class="pi pi-book mr-2 text-amber-400"></i>
                        {{ menu.name }}
                      </h5>
                      <p-tag [value]="menu.isActive ? 'Active' : 'Inactive'"
                        [severity]="menu.isActive ? 'success' : 'danger'" class="text-xs" />
                      @if (menu.dishes) {
                      <span class="px-2 py-1 bg-neutral-700 text-neutral-300 rounded-full text-xs">
                        {{ menu.dishes.length }} dishes
                      </span>
                      }
                    </div>
                    <div class="flex gap-2">
                      <p-button (onClick)="showEditMenuForm(menu.id)" icon="pi pi-pencil" size="small" severity="info"
                        pTooltip="Edit Menu" tooltipPosition="top" class="w-8 h-8" />
                      <p-button (onClick)="showCreateDishForm(menu.id)" icon="pi pi-plus" size="small" severity="success" pTooltip="Add Dish"
                        tooltipPosition="top" class="w-8 h-8" />
                      <p-button (onClick)="onDeleteMenu($event, menu.id)" icon="pi pi-trash" size="small"
                        severity="danger" pTooltip="Delete Menu" tooltipPosition="top" class="w-8 h-8" />
                    </div>
                  </div>

                  @if (menu.description) {
                  <p class="text-neutral-400 text-sm mb-3">{{ menu.description }}</p>
                  } @if (menu.dishes && menu.dishes.length > 0) {
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-4">
                    @for (dish of menu.dishes; track dish.id) {
                    <div
                      class="bg-neutral-700/30 rounded-lg p-3 border border-neutral-600/20 hover:border-amber-400/30 transition-colors">
                      <div class="flex items-start justify-between mb-2">
                        <div class="flex-1 min-w-0">
                          <h6 class="font-medium text-neutral-100 text-sm truncate">
                            {{ dish.name }}
                          </h6>
                          <p class="text-amber-400 font-semibold">${{ dish.price }}</p>
                          @if (dish.category) {
                          <span class="text-xs text-neutral-500">{{ dish.category }}</span>
                          }
                        </div>
                        <div class="flex gap-1 ml-2">
                          <p-button (onClick)="showEditDishForm(menu.id, dish.id)" icon="pi pi-pencil" size="small" severity="info" [text]="true" pTooltip="Edit Dish"
                            tooltipPosition="top" class="w-6 h-6" />
                          <p-button (onClick)="onDeleteDish($event, dish.id)" icon="pi pi-trash" size="small" severity="danger" [text]="true"
                            pTooltip="Delete Dish" tooltipPosition="top" class="w-6 h-6" />
                        </div>
                      </div>

                      @if (dish.description) {
                      <p class="text-neutral-400 text-xs mb-2 line-clamp-2">
                        {{ dish.description }}
                      </p>
                      }

                      <div class="flex items-center justify-between text-xs">
                        <span class="px-2 py-1 rounded-full" [class]="
                            dish.isAvailable
                              ? 'bg-green-900/50 text-green-300'
                              : 'bg-red-900/50 text-red-300'
                          ">
                          {{ dish.isAvailable ? 'Available' : 'Unavailable' }}
                        </span>
                        <div class="flex items-center gap-2">
                          @if (dish.avgRating && dish.avgRating > 0) {
                          <span class="text-amber-400 flex items-center">
                            <i class="pi pi-star-fill mr-1"></i>
                            {{ dish.avgRating | number : '1.1-1' }}
                          </span>
                          } @if (dish.imageUrl) {
                          <i class="pi pi-image text-neutral-400 cursor-pointer" [pTooltip]="imageTooltip"
                            tooltipPosition="bottom" fitContent="true" [tooltipOptions]="{
                              showDelay: 350,
                              hideDelay: 350,
                              positionStyle: 'absolute',
                            }"></i>

                          <ng-template #imageTooltip>

                            <img [src]="dish.imageUrl" [alt]="dish.name"
                              class="w-64 aspect-auto object-cover rounded mb-2" />
                            <div class="text-xs text-neutral-300 text-center">{{ dish.name }}</div>

                          </ng-template>
                          } @if (dish.ratings && dish.ratings.length > 0) {
                          <span class="text-neutral-400" [pTooltip]="dish.ratings.length + ' reviews'">
                            <i class="pi pi-comment mr-1"></i>{{ dish.ratings.length }}
                          </span>
                          }
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                  } @else {
                  <div class="text-center py-4 text-neutral-500 text-sm border-t border-neutral-600/30 mt-3">
                    <i class="pi pi-info-circle mr-2"></i>
                    No dishes in this menu yet
                    <p-button label="Add First Dish" icon="pi pi-plus" severity="success" size="small" [text]="true"
                      class="ml-3" />
                  </div>
                  }
                </div>
                }
              </div>
              } @else {
              <div class="text-center py-8 text-neutral-500">
                <div class="text-4xl mb-3">ğŸ½ï¸</div>
                <p class="text-lg font-medium text-neutral-300 mb-2">No menus created yet</p>
                <p class="text-sm mb-4">Start by adding a menu to organize your dishes</p>
                <p-button label="Create First Menu" icon="pi pi-plus" severity="success"
                  class="bg-amber-500 hover:bg-amber-600 border-0 text-slate-900 font-medium" />
              </div>
              }
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="">
            <div class="flex flex-col items-center text-center space-y-4 p-8">
              <div class="space-y-4">
                <div class="text-6xl text-neutral-600 mb-4">ğŸª</div>
                <div class="text-xl font-semibold text-neutral-300">No restaurants found</div>
                <div class="text-neutral-500">
                  Try adjusting your search criteria or add a new restaurant
                </div>
              </div>
              <div class="flex gap-3">
                <p-button label="Clear Search" icon="pi pi-filter-slash" severity="secondary" (onClick)="dt2.clear()" />
                <p-button label="Add Restaurant" icon="pi pi-plus" severity="success" />
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-confirmdialog />
